rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function myUid() { return request.auth.uid; }

    function isSuperAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/platformUsers/$(myUid()))
        && get(/databases/$(database)/documents/platformUsers/$(myUid())).data.role == "superadmin"
        && get(/databases/$(database)/documents/platformUsers/$(myUid())).data.active == true;
    }

    function myCompanyId() {
      return get(/databases/$(database)/documents/userCompanies/$(myUid())).data.companyId;
    }

    function myCompanyUserDoc(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(myUid()));
    }

    function isCompanyAdmin(companyId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/userCompanies/$(myUid()))
        && companyId == myCompanyId()
        && exists(/databases/$(database)/documents/companies/$(companyId)/users/$(myUid()))
        && myCompanyUserDoc(companyId).data.role == "admin"
        && myCompanyUserDoc(companyId).data.active == true;
    }

    function isManager(companyId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/userCompanies/$(myUid()))
        && companyId == myCompanyId()
        && exists(/databases/$(database)/documents/companies/$(companyId)/users/$(myUid()))
        && myCompanyUserDoc(companyId).data.role == "gestor"
        && myCompanyUserDoc(companyId).data.active == true;
    }

    function userFieldsAllowed() {
      return request.resource.data.keys().hasOnly([
        "name","role","teamId","teamIds","managedTeamIds","email","phone","photoURL","active"
      ]);
    }

    function roleValid() {
      return request.resource.data.role in ["admin","gestor","coordenador","tecnico"];
    }

    function nameValid() {
      return request.resource.data.name is string && request.resource.data.name.size() > 0;
    }

    function emailValid() {
      return request.resource.data.email is string && request.resource.data.email.size() > 0;
    }

    function phoneValid() {
      // telefone opcional
      return !("phone" in request.resource.data) || (request.resource.data.phone is string);
    }

    function photoUrlOptionalValid() {
      return !("photoURL" in request.resource.data) || (request.resource.data.photoURL is string);
    }

    function activeValid() {
      return request.resource.data.active is bool;
    }

    function teamIdOptionalValid() {
      return !("teamId" in request.resource.data)
        || (request.resource.data.teamId is string);
    }

    function teamIdsOptionalValid() {
      return !("teamIds" in request.resource.data)
        || (request.resource.data.teamIds is list);
    }

    function managedTeamIdsOptionalValid() {
      return !("managedTeamIds" in request.resource.data)
        || (request.resource.data.managedTeamIds is list);
    }

    function userTeamsRuleValid() {
      return request.resource.data.role == "admin"
        || (
          (("teamIds" in request.resource.data) && request.resource.data.teamIds.size() >= 1)
          || (("teamId" in request.resource.data) && request.resource.data.teamId.size() > 0)
        );
    }

    function teamsSubsetOfMyManaged(companyId) {
      return ("teamIds" in request.resource.data)
        && request.resource.data.teamIds is list
        && request.resource.data.teamIds.size() >= 1
        && request.resource.data.teamIds.hasOnly(myCompanyUserDoc(companyId).data.managedTeamIds);
    }

    // platformUsers
    match /platformUsers/{uid} {
      allow read: if isSuperAdmin() || (isSignedIn() && uid == myUid());
      allow write: if false;
    }

    // userCompanies
    match /userCompanies/{uid} {
      allow read: if isSuperAdmin() || (isSignedIn() && uid == myUid());

      allow create, update: if isSuperAdmin()
        && request.resource.data.keys().hasOnly(["companyId"])
        && request.resource.data.companyId is string
        && request.resource.data.companyId.size() > 0;

      allow create, update: if !isSuperAdmin()
        && isCompanyAdmin(request.resource.data.companyId)
        && request.resource.data.keys().hasOnly(["companyId"])
        && request.resource.data.companyId is string
        && request.resource.data.companyId.size() > 0;

      allow create, update: if !isSuperAdmin()
        && isManager(request.resource.data.companyId)
        && request.resource.data.keys().hasOnly(["companyId"])
        && request.resource.data.companyId is string
        && request.resource.data.companyId == myCompanyId();

      allow delete: if false;
    }

    // companies
    match /companies/{companyId} {
      allow read: if isSuperAdmin() || (isSignedIn() && companyId == myCompanyId());

      allow create: if isSuperAdmin()
        && request.resource.data.keys().hasOnly(["name", "cnpj", "active", "createdAt", "createdBy"])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.cnpj is string
        && request.resource.data.cnpj.size() > 0
        && request.resource.data.active is bool
        && request.resource.data.createdBy == myUid();

      allow update: if isSuperAdmin()
        && request.resource.data.keys().hasOnly(["name", "cnpj", "active", "createdAt", "createdBy"])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.cnpj is string
        && request.resource.data.cnpj.size() > 0
        && request.resource.data.active is bool;

      allow delete: if false;

      // teams
      match /teams/{teamId} {
        allow read: if isSuperAdmin() || isCompanyAdmin(companyId);

        allow create, update: if isSuperAdmin()
          && request.resource.data.keys().hasOnly(["name","active","createdAt","createdBy"])
          && request.resource.data.name is string && request.resource.data.name.size() > 0
          && request.resource.data.active is bool;

        allow create, update: if !isSuperAdmin()
          && isCompanyAdmin(companyId)
          && request.resource.data.keys().hasOnly(["name","active","createdAt","createdBy"])
          && request.resource.data.name is string && request.resource.data.name.size() > 0
          && request.resource.data.active is bool;

        allow delete: if false;
      }

      // users
      match /users/{uid} {

        allow read: if isSuperAdmin()
          || isCompanyAdmin(companyId)
          || (isSignedIn() && uid == myUid() && companyId == myCompanyId());

        function userWriteValid() {
          return userFieldsAllowed()
            && nameValid()
            && roleValid()
            && emailValid()
            && phoneValid()
            && photoUrlOptionalValid()
            && activeValid()
            && teamIdOptionalValid()
            && teamIdsOptionalValid()
            && managedTeamIdsOptionalValid()
            && userTeamsRuleValid();
        }

        // ✅ usuário logado pode atualizar SOMENTE o próprio perfil (nome/telefone/foto)
        function selfProfileUpdateValid() {
          return request.resource.data.diff(resource.data).changedKeys().hasOnly([
              "name","phone","photoURL"
            ])
            && (request.resource.data.name is string && request.resource.data.name.size() > 0)
            && (!("phone" in request.resource.data) || request.resource.data.phone is string)
            && (!("photoURL" in request.resource.data) || request.resource.data.photoURL is string);
        }

        allow update: if (isSignedIn() && uid == myUid() && companyId == myCompanyId())
          && selfProfileUpdateValid();

        // master / admin da empresa
        allow create, update: if (isSuperAdmin() || isCompanyAdmin(companyId))
          && userWriteValid();

        // gestor: pode criar/atualizar SOMENTE técnico, e SOMENTE nas equipes que ele administra
        allow create, update: if isManager(companyId)
          && request.resource.data.role == "tecnico"
          && userWriteValid()
          && teamsSubsetOfMyManaged(companyId);

        allow delete: if false;
      }

      match /{document=**} {
        allow read, write: if false;
      }
    }
  }
}
